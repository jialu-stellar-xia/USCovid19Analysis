---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Results

```{r}
library(tidyverse)
Covid_19<-read.csv("data/Covid19_selected.csv")
```

## Parallel coordinates plot for total cases 
```{r}
Pc_data<-Covid_19 %>% 
  select(date,state,new_case) %>% 
  drop_na() %>% 
  mutate(month=cut(as.Date(date),breaks='month',labels=c('Mar',"Apr","May","Jun","Jul","Aug","Sep","Oct","Nov"))) %>% 
  group_by(month,state) %>% 
  summarise(monthly_total_new_case=round(sum(new_case),0)) %>% 
  ungroup()
```
```{r}
Pc_tidydata<-Pc_data %>% 
  spread(month, monthly_total_new_case)
```

```{r}
library(fivethirtyeight)
library(parcoords)
parcoords(Pc_tidydata, brushMode = "1d-axes", reorderable = TRUE, rownames = FALSE)
```

## Pie chart for inpatient beds utilization

```{r}
pie_data<-Covid_19 %>% 
  select(date,state,inpatient_beds,inpatient_beds_used,inpatient_beds_used_covid) %>% 
  filter(date=="2020-11-15") %>% 
  filter(state=="NJ") %>% 
  mutate(inpatient_beds_empty=inpatient_beds-inpatient_beds_used,inpatient_beds_used_others=inpatient_beds_used-inpatient_beds_used_covid) %>% 
  select(date,state,inpatient_beds_empty,inpatient_beds_used_covid,inpatient_beds_used_others)
```
```{r}
pie_tidydata<-pie_data %>% 
  pivot_longer(cols=!c(date,state),names_to="group",values_to="number") %>% 
  mutate(group=as.factor(group)) %>% 
  mutate(value=number/sum(number)*100) %>% 
  mutate(ypos=cumsum(value)-0.5*value) %>% 
  mutate(group=fct_relevel(group,'inpatient_beds_used_others','inpatient_beds_used_covid','inpatient_beds_empty'))
```
```{r}
library(scales)
pie_tidydata %>% ggplot(aes(x="",y=value,fill=group))+
  geom_bar(stat="identity",width=1)+
  coord_polar('y')+
  theme_void()+
  geom_text(aes(x=1.2,y=ypos,label=percent(value/100)),color="black",size=6)+
  scale_fill_brewer()+
  ggtitle("Inpatient beds utilization")+
  theme(plot.title = element_text(face="bold",hjust = 0.5))

```

## Cleveland dot plot for inpatient bed availability
```{r}
Cd_data<-Covid_19 %>% 
  select(date,state,inpatient_beds,inpatient_beds_used) %>% 
  mutate(inpatient_beds_availible=inpatient_beds-inpatient_beds_used) %>%
  drop_na() %>% 
  mutate(month=cut(as.Date(date),breaks='month',labels=c('Mar',"Apr","May","Jun","Jul","Aug","Sep","Oct","Nov"))) %>% 
  group_by(month,state) %>% 
  summarise(avrg_inpatient_beds_available=round(mean(inpatient_beds_availible),0))
```

```{r fig.height=10,fig.width=12}
Cd_data %>% 
  ggplot(aes(x=avrg_inpatient_beds_available,y=reorder(state,avrg_inpatient_beds_available)))+
  geom_point()+
  facet_wrap(~month,nrow=1,ncol = 9)+
  ylab("")+
  ggtitle("Monthly average number of avaliable inpatient beds over states")+
  theme(plot.title = element_text(face="bold",hjust = 0.5))
```

From this dot plot, we can clearly see that hospitals in most of the states increased inpatient beds. Compare to other states, FL, CA, TX and NY prepared more beds for Covid patient.

## Heatmap for death rate and bed availability 

```{r}
library(zoo)
dot_data<-Covid_19 %>% 
  select(date,state,inpatient_beds,inpatient_beds_used,tot_cases,tot_death) %>% 
  mutate(inpatient_beds_availible=inpatient_beds-inpatient_beds_used) %>%
  drop_na() %>%
  mutate(death_rate=tot_death/tot_cases) %>% 
  group_by(state) %>% 
  mutate(capacity_07=rollmean(inpatient_beds_availible,k=7,fill=NA)) %>% 
  mutate(death_rate_07=rollmean(death_rate,k=7,fill=NA)) %>% 
  drop_na()
```


```{r}
dot_data %>% 
  ggplot(aes(capacity_07,death_rate_07)) +
  scale_fill_gradient(low="#F6F8FB",high="#09005F")+
  geom_hex(bins=10)+
  xlab("7-days average available inpatient beds")+
  ylab("7-days death rate")+
  ggtitle("Heatmap for inpatient beds availability and Covid19 death rate")+
  theme(plot.title = element_text(face="bold",hjust = 0.5))
```

This is a heatmap for available impatient beds and death rate. Because there is a delay for reporting death and death rate is more likely relating to number of available bed before death, we use the 7 days average value to see the relationship. It shows in the heapmap that

* Data with death rate higher than 10% has number of available inpatient beds less than 5000.

* When there are more than 15000 available inpatient beds, the death rate is below 5%.

## Death rate and hospital admission rate (US)
```{r}
dh_data<-Covid_19 %>% 
  select(date,state,tot_cases,tot_death,total_adult_patients_hospitalized_confirmed_covid,total_pediatric_patients_hospitalized_confirmed_covid) %>%
  mutate(total_hospitalized_confirmed_covid=total_adult_patients_hospitalized_confirmed_covid+total_pediatric_patients_hospitalized_confirmed_covid) %>% 
  group_by(date) %>% 
  summarise_at(.vars=vars(tot_cases,tot_death,total_hospitalized_confirmed_covid),
    .funs = c(sum="sum")) %>% 
  
  mutate(death_rate=tot_death_sum/tot_cases_sum,hospital_admission_rate=total_hospitalized_confirmed_covid_sum/tot_cases_sum) %>%
  mutate(death_rate_07=rollmean(death_rate,k=7,fill=NA)) %>% 
  mutate(hospital_admission_rat_07=rollmean(hospital_admission_rate,k=7,fill=NA)) %>% 
  drop_na()
  
# hospital admission data start at 7-26
```

```{r}
dh_tidydata <- dh_data%>% 
  select(date,death_rate,hospital_admission_rate) %>% 
  pivot_longer(cols=c(death_rate,hospital_admission_rate),names_to="variable",values_to="rate") 
```

```{r}
dh_tidydata %>% ggplot(aes(x=as.Date(date),y=rate)) +
  geom_line(aes(color=variable)) + 
  scale_x_date(date_breaks="4 weeks")+
  xlab("") +
  ylim(0,0.03)+
  ggtitle("Nationwide death rate vs. hospital admission rate")+
  theme(plot.title = element_text(face="bold",hjust = 0.5))
```




